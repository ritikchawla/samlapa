<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Real-time Chat</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 1rem; }
    #chat { max-width: 600px; margin: auto; }
    .message { padding: 0.5rem; border-bottom: 1px solid #eee; }
    .typing { font-style: italic; color: #888; }
  </style>
</head>
<body>
  <div id="chat"></div>
  <script type="module">
    import React, { useState, useEffect, useRef } from 'https://esm.sh/react@17';
    import ReactDOM from 'https://esm.sh/react-dom@17';
    import { generateAndUploadKeys, fetchUserKeys } from './signal.js';
    import { encryptMessage, decryptMessage, setupUser } from './signal-chat.js';

    function App() {
      const [username, setUsername] = useState('');
      const [connected, setConnected] = useState(false);
      const [ws, setWs] = useState(null);
      const [messages, setMessages] = useState([]);
      const [typingUsers, setTypingUsers] = useState({});
      const [input, setInput] = useState('');

      useEffect(() => {
        if (!connected) return;
        const socket = new WebSocket(`ws://${window.location.host}/ws`);
        socket.onopen = () => console.log('Connected');
        socket.onmessage = (evt) => {
          const env = JSON.parse(evt.data);
          if (env.type === 'typing') {
            setTypingUsers(t => ({ ...t, [env.sender]: true }));
            setTimeout(() => {
              setTypingUsers(t => { const copy = { ...t }; delete copy[env.sender]; return copy; });
            }, 1000);
          } else if (env.type === 'message') {
            // Decrypt if message is for this user
            let text = env.content;
            if (env.to === username) {
              decryptMessage(env.sender, env.content)
                .then(decrypted => {
                  setMessages(msgs => [...msgs, { sender: env.sender, text: decrypted, seq: env.seq }]);
                })
                .catch(() => {
                  setMessages(msgs => [...msgs, { sender: env.sender, text: "[decryption failed]", seq: env.seq }]);
                });
              return;
            }
            setMessages(msgs => [...msgs, { sender: env.sender, text, seq: env.seq }]);
          }
        };
        setWs(socket);
        return () => socket.close();
      }, [connected]);

      const handleJoin = async () => {
        await generateAndUploadKeys(username);
        setConnected(true);
      };

      const sendMessage = async () => {
        if (!ws || !input) return;
        // For demo, send to a hardcoded recipient (replace with actual recipient logic)
        const recipient = prompt("Send to (username):");
        if (!recipient) return;
        const ciphertext = await encryptMessage(username, recipient, input);
        ws.send(JSON.stringify({ type: 'message', sender: username, content: ciphertext, to: recipient }));
        setInput('');
      };

      const handleTyping = () => {
        if (ws) ws.send(JSON.stringify({ type: 'typing', sender: username }));
      };

      return (
        <div id="chat">
          {!connected ? (
            <div>
              <input
                placeholder="Username"
                value={username}
                onChange={e => setUsername(e.target.value)}
              />
              <button onClick={handleJoin}>Join Chat</button>
            </div>
          ) : (
            <div>
              <div>
                {messages.map(m => (
                  <div key={m.seq} className="message">
                    <strong>{m.sender}:</strong> {m.text}
                  </div>
                ))}
                {Object.keys(typingUsers).map(u => (
                  <div key={u} className="typing">{u} is typing...</div>
                ))}
              </div>
              <input
                placeholder="Type a message"
                value={input}
                onChange={e => { setInput(e.target.value); handleTyping(); }}
                onKeyDown={e => e.key === 'Enter' && sendMessage()}
              />
              <button onClick={sendMessage}>Send</button>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('chat'));
  </script>
</body>
</html>